<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>修改 main7.31 copy.py 的 query</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {height: 100%; margin: 0; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;}
    .wrap {display:flex;align-items:center;justify-content:center;height:100%;background:#f6f7f9;}
    .card {width:min(560px,92vw);background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:24px 24px 28px;}
    h1 {font-size:20px;margin:0 0 16px;}
    .row {display:flex;align-items:center;gap:8px;margin:8px 0;}
    .field {display:flex;gap:12px;margin:12px 0 6px;}
    input[type="text"] {flex:1;font-size:16px;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;outline:none;}
    input[type="text"]:focus {border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.15);}
    button {padding:10px 16px;font-size:15px;border:none;border-radius:10px;cursor:pointer;background:#111827;color:#fff;}
    .muted {color:#6b7280;font-size:13px;margin-top:10px;word-break:break-all;}
    .status {margin-top:14px;font-size:14px;}
    .ok {color:#16a34a;}
    .err {color:#dc2626;}
    code {background:#f3f4f6;padding:2px 6px;border-radius:6px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>更新 <code>query</code>（写回 Python 文件）</h1>

      <div class="row">
        <div>当前 <code>query</code>：</div>
        <div id="current" class="muted">读取中…</div>
      </div>

      <div class="field">
        <input id="q" type="text" placeholder='例如：INTP / ESFP / "任意字符串"' />
        <button id="save">保存</button>
      </div>

      <div class="muted">
        将修改：<code>/Users/satoh/Desktop/Spider_XHS-master3/main7.31 copy.py</code> 中第一条形如 <code>query = "..."</code> 的行，并自动备份到
        <code>.backups/</code>。
      </div>

      <div id="status" class="status"></div>
    </div>
  </div>

  <script>
    const currentEl = document.getElementById('current');
    const statusEl = document.getElementById('status');
    const inputEl = document.getElementById('q');
    const btnEl = document.getElementById('save');

    function setStatus(msg, ok=true) {
      statusEl.textContent = msg;
      statusEl.className = 'status ' + (ok ? 'ok' : 'err');
    }

    async function loadCurrent() {
      try {
        const r = await fetch('/current');
        const data = await r.json();
        if (data.ok) {
          currentEl.textContent = (data.query ?? '(未找到)');
          if (data.query) inputEl.value = data.query;
        } else {
          currentEl.textContent = '读取失败';
          setStatus(data.error || '无法读取当前值', false);
        }
      } catch (e) {
        currentEl.textContent = '读取失败';
        setStatus(e.message, false);
      }
    }

    btnEl.addEventListener('click', async () => {
      const v = inputEl.value.trim();
      if (!v) return setStatus('请输入 query', false);

      setStatus('保存中…');
      try {
        const r = await fetch('/update', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ query: v })
        });
        const data = await r.json();
        if (data.ok) {
          setStatus(`已保存：query = "${data.new_query}"`, true);
          currentEl.textContent = data.new_query;
        } else {
          setStatus(data.error || '保存失败', false);
        }
      } catch (e) {
        setStatus(e.message, false);
      }
    });

    loadCurrent();
  </script>
</body>
</html>